<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>小精靈上傳網站（Flask）</title>

  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: "微軟正黑體";
      background: #f8f8f8;
    }

    h2 {
      text-align: center;
      font-size: 1.4em;
    }

    .panel {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #upload-box {
      width: 100%;
      height: 140px;
      border: 2px dashed #aaa;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      background: #fafafa;
      margin-bottom: 10px;
    }

    #upload-box.hover {
      background: #eee;
      border-color: #666;
    }

    .btn {
      width: 100%;
      background: #3498db;
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 1.2em;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
    }

    th {
      background: #f0f0f0;
    }

    .ok { color: green; }
    .fail { color: red; }

  </style>
</head>

<body>

  <div class="panel">
    <h2>單次最多上傳 50 張</h2>

    <div id="upload-box">
      <p>點擊或拖曳圖片</p>
      <input id="files" type="file" accept="image/*" multiple style="display:none;">
    </div>

    <button class="btn" id="uploadBtn" disabled>開始上傳</button>

    <div id="status"></div>
    <div id="resultArea"></div>
  </div>

<script>
  const box = document.getElementById('upload-box')
  const input = document.getElementById('files')
  const uploadBtn = document.getElementById('uploadBtn')
  const statusEl = document.getElementById('status')
  const resultArea = document.getElementById('resultArea')

  box.addEventListener('click', () => input.click())

  input.addEventListener('change', () => {
    uploadBtn.disabled = input.files.length === 0
  })

  uploadBtn.addEventListener('click', () => {
    const files = Array.from(input.files)
    statusEl.innerText = '準備中…'
    uploadBtn.disabled = true

    let list = []
    let done = 0

    files.forEach(f => {
      const reader = new FileReader()
      reader.onload = e => {
        list.push({
          name: f.name,
          type: f.type,
          data: e.target.result.split(',')[1]
        })
        done++
        if (done === files.length) sendToServer(list)
      }
      reader.readAsDataURL(f)
    })
  })

  function sendToServer(files) {
    statusEl.innerText = "上傳中..."

    fetch("/upload", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({files})
    })
    .then(r => r.json())
    .then(res => {
      statusEl.innerText = "完成！"
      render(res)
      input.value = ""
      uploadBtn.disabled = true
    })
  }

  function render(rows) {
    let html = "<table><tr><th>檔名</th><th>股號-姓名</th><th>狀態</th><th>alert</th></tr>"
    rows.forEach(r => {
      html += `<tr>
        <td>${r.name}</td>
        <td>${r.codeName}</td>
        <td>${r.success ? '<span class=ok>成功</span>' : '<span class=fail>失敗</span>'}</td>
        <td>${r.alert}</td>
      </tr>`
    })
    html += "</table>"
    resultArea.innerHTML = html
  }
</script>

</body>
</html>